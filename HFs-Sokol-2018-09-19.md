## Info
* **Network**: Sokol
* **Date**: 2018-09-19
* **Block number**: 4622420

## Description
### Problems
- Governance smart contracts are non-upgradable.
- Feature request: we need to increase emission supply for self-sustainability of the network (https://github.com/poanetwork/RFC/issues/14).
- Feature request: there is no ability to create one ballot for three keys (https://github.com/poanetwork/poa-network-consensus-contracts/issues/92).
- Feature request: there is no ability to finalize ballot earlier if all validators voted before the end of a ballot (https://github.com/poanetwork/RFC/issues/8).
- DApp performance: There are no tuple getters in smart contracts. It leads to low performance of `Voting DApp`.
- `pragma solidity ^0.4.18;` used for governance smart contracts is outdated.
- Smart contracts need to be refactored in order to make them easy to read.
- Smart contracts need to be checked for security and design issues.
- Minor bugs.

### Changelog

#### Major changes
- smart contracts were made upgradable: `BallotsStorage`, `KeysManager`, `ProxyStorage`, `ValidatorMetadata`, `VotingToChangeKeys`, `VotingToChangeMinThreshold`, `VotingToChangeProxyAddress`;
- scripts for migration from old to new smart contracts were added to `scripts/migrate` directory;
- new smart contracts for `Increased Emission Supply` were added: `VotingToManageEmissionFunds`, `EmissionFunds`, `RewardByBlock`;
- a new feature was implemented for creating a ballot to add new validator with three keys at once;
- a new feature was implemented for finalizing a ballot before its end time in case of all validators voted;
- tuple getters were added to increase performance of `Voting DApp`;
- smart contracts were migrated to the latest stable `Solidity` compiler version (`0.4.24`);
- smart contracts were refactored;
- npm packages were updated;
- found bugs were fixed;
- test environment was updated (`ganache-cli` instead of `testrpc`, new `solidity-coverage`);
- security improvements were made according to reports of security audits.

#### Major pull requests
- (Feature) Add script for checking contracts' functions for a clashing (https://github.com/poanetwork/poa-network-consensus-contracts/pull/179)
- (Fix) Reduce gas spending, improve migrations, and minor enhancements (https://github.com/poanetwork/poa-network-consensus-contracts/pull/171)
- (Feature) Allow cancellation of a ballot in `VotingToManageEmissionFunds` by its creator for 15 minutes after it's created (https://github.com/poanetwork/poa-network-consensus-contracts/pull/168)
- (Fix) Accounting of pending confirmations in ValidatorMetadata's `moveMetadata` and `clearMetadata` functions (https://github.com/poanetwork/poa-network-consensus-contracts/pull/164)
- (Fix) Add moveMetadata and clearMetadata functions to ValidatorMetadata contract (https://github.com/poanetwork/poa-network-consensus-contracts/pull/158)
- (Fix) Finalization without reverts, optimizations and unit tests updates (https://github.com/poanetwork/poa-network-consensus-contracts/pull/155)
- (Fix) Remove changing of ProxyStorage's address from ValidatorMetadata (https://github.com/poanetwork/poa-network-consensus-contracts/pull/150)
- (Feature) Block Reward emission by time (https://github.com/poanetwork/poa-network-consensus-contracts/pull/133)
- (Feature) Add extra getters for Voting DApp optimization (https://github.com/poanetwork/poa-network-consensus-contracts/pull/129)
- (Feature) Add new validator with mining/voting/payout keys at once (https://github.com/poanetwork/poa-network-consensus-contracts/pull/118)
- (Feature) Allow finalize at once if all validators gave their votes (https://github.com/poanetwork/poa-network-consensus-contracts/pull/113)
- (Fix) removeVotingKey and removePayoutKey shouldn't revert if voting/ payout key is already removed (https://github.com/poanetwork/poa-network-consensus-contracts/pull/127)
- (Fix) Add missed unit tests (https://github.com/poanetwork/poa-network-consensus-contracts/pull/125)
- (Refactor) Small enhancements, refactoring and fixes (https://github.com/poanetwork/poa-network-consensus-contracts/pull/122)
- (Refactor) Update solc to 0.4.24 and truffle to 4.1.11 (https://github.com/poanetwork/poa-network-consensus-contracts/pull/106)
- (Feature) Unit tests and enhancements for Increased Emission Supply (https://github.com/poanetwork/poa-network-consensus-contracts/pull/105)
- (Fix) MoC can be removed (https://github.com/poanetwork/poa-network-consensus-contracts/pull/101)
- (Fix) Update web3 (https://github.com/poanetwork/poa-network-consensus-contracts/pull/99)
- (Refactor) New smart contracts refactoring (https://github.com/poanetwork/poa-network-consensus-contracts/pull/96)
- (Feature) Add BlockReward contract (https://github.com/poanetwork/poa-network-consensus-contracts/pull/83)
- (Refactor) Code refactoring (https://github.com/poanetwork/poa-network-consensus-contracts/pull/82)
- (Feature) Upgradable contracts (https://github.com/poanetwork/poa-network-consensus-contracts/pull/81)
- (Fix) Proposals from auditors (https://github.com/poanetwork/poa-network-consensus-contracts/pull/135)

#### Minor pull requests
- (Refactor) Put address arguments at the end of argument list of functions (https://github.com/poanetwork/poa-network-consensus-contracts/pull/178)
- (Refactor) Remove `this` and other code improvements (https://github.com/poanetwork/poa-network-consensus-contracts/pull/175)
- (Fix) Replace uint8 with uint256 to reduce gas spending (https://github.com/poanetwork/poa-network-consensus-contracts/pull/174)
- (Fix) Minor improvements of KeysManager and PoaNetworkConsensus.setProxyStorage (https://github.com/poanetwork/poa-network-consensus-contracts/pull/173)
- (Fix) Remove theoretical reentrancy from `VotingTo._createBallot` method and other enhancements (https://github.com/poanetwork/poa-network-consensus-contracts/pull/170)
- (Fix) Security enhancements of `VotingToChange*.migrateBasicOne` function (https://github.com/poanetwork/poa-network-consensus-contracts/pull/169)
- (Fix) Deny using VotingToChange* functions unless migration is completed (https://github.com/poanetwork/poa-network-consensus-contracts/pull/167)
- (Feature) Checking if a voting key is EOA or a contract in VotingToManageEmissionFunds (https://github.com/poanetwork/poa-network-consensus-contracts/pull/165)
- (Refactor) Move `implementation` and `version` functions from `EternalStorage` to `EternalStorageProxy` (https://github.com/poanetwork/poa-network-consensus-contracts/pull/163)
- (Refactor) Replace returns(address) with returns(interface) in several private functions (https://github.com/poanetwork/poa-network-consensus-contracts/pull/162)
- (Fix) Using of BallotsStorage.getProxyThreshold in VotingToManageEmissionFunds (https://github.com/poanetwork/poa-network-consensus-contracts/pull/160)
- (Fix) Replace abi.encodePacked with abi.encode (https://github.com/poanetwork/poa-network-consensus-contracts/pull/159)
- (Fix) ValidatorMetadata contract enhancements (https://github.com/poanetwork/poa-network-consensus-contracts/pull/157)
- (Fix) PoaNetworkConsensus contract and KeysManager.migrateMiningKey function (https://github.com/poanetwork/poa-network-consensus-contracts/pull/156)
- (Fix) Removing usage of a free pointer from EternalStorageProxy's fallback function (https://github.com/poanetwork/poa-network-consensus-contracts/pull/151)
- (Refactor) A few enhancements proposed by auditors (https://github.com/poanetwork/poa-network-consensus-contracts/pull/149)
- (Refactor) Add KeysManager.getInitialKeyStatus function instead of initialKeys and getInitialKey (https://github.com/poanetwork/poa-network-consensus-contracts/pull/148)
- (Fix) Don't allow adding voting/ payout key for zero mining key (https://github.com/poanetwork/poa-network-consensus-contracts/pull/147)
- (Fix) Fixes and enhancements of BallotsStorage.sol, EternalStorageProxy.sol, KeysManager.sol, ValidatorMetadata.sol, VotingToChange.sol, VotingToChangeKeys.sol (https://github.com/poanetwork/poa-network-consensus-contracts/pull/145, https://github.com/poanetwork/poa-network-consensus-contracts/pull/146, https://github.com/poanetwork/poa-network-consensus-contracts/pull/152, https://github.com/poanetwork/poa-network-consensus-contracts/pull/153, https://github.com/poanetwork/poa-network-consensus-contracts/pull/166)
- (Feature) A new RewardByBlock.addExtraReceiver function (https://github.com/poanetwork/poa-network-consensus-contracts/pull/144)
- (Fix) Add keeping of RewardByBlock and VotingToManageEmissionFunds addresses to ProxyStorage (https://github.com/poanetwork/poa-network-consensus-contracts/pull/143)
- (Fix) Fixes of migration scripts (https://github.com/poanetwork/poa-network-consensus-contracts/pull/141, https://github.com/poanetwork/poa-network-consensus-contracts/pull/142)
- (Fix) BlockReward upgradability and splitting into RewardByBlock and RewardByTime (https://github.com/poanetwork/poa-network-consensus-contracts/pull/140)
- (Fix) Add solc to scripts/package.json (https://github.com/poanetwork/poa-network-consensus-contracts/pull/138)
- (Refactor) Rename BlockReward.rewardHBBFT function to rewardByTime (https://github.com/poanetwork/poa-network-consensus-contracts/pull/136)
- (Refactor) Rewrite migrations/2_deploy_contract.js (https://github.com/poanetwork/poa-network-consensus-contracts/pull/134)
- (Fix) Checking transaction status in scripts/migrate (https://github.com/poanetwork/poa-network-consensus-contracts/pull/132)
- (Fix) Refreshing unit tests' results in README (https://github.com/poanetwork/poa-network-consensus-contracts/pull/131)
- (Fix) "Stack too deep" error in VotingToChangeKeys.getBallotInfo (https://github.com/poanetwork/poa-network-consensus-contracts/pull/130)
- (Fix) migrations/2_deploy_contract.js (https://github.com/poanetwork/poa-network-consensus-contracts/pull/124)
- (Fix) PoaNetworkConsensus small changes (https://github.com/poanetwork/poa-network-consensus-contracts/pull/123)
- (Refactor) Enhancements and fixes (https://github.com/poanetwork/poa-network-consensus-contracts/pull/112)
- (Fix) Unit tests for solidity-coverage (https://github.com/poanetwork/poa-network-consensus-contracts/pull/109)
- (Fix) KeysManager and a few enhancements (https://github.com/poanetwork/poa-network-consensus-contracts/pull/104)
- (Fix) Known vulnerability in `hoek@4.2.0` dependency (https://github.com/poanetwork/poa-network-consensus-contracts/pull/97)
- (Fix) README text about PoaNetworkConsensus bytecode (https://github.com/poanetwork/poa-network-consensus-contracts/pull/79)
- (Refactor) Collapse master and demo branch (https://github.com/poanetwork/poa-network-consensus-contracts/pull/76)

### Solution
1. Deploy new smart contracts and migrate all the data from old to new contracts with [`scripts/migrate/migrateAll.js`](https://github.com/poanetwork/poa-network-consensus-contracts/blob/7df89c25a376875356810e56a6ba8f821224689f/scripts/migrate/migrateAll.js).
2. Update [`spec.json`](https://github.com/poanetwork/poa-chain-spec/blob/sokol/spec.json):
  add an address of the new `PoaNetworkConsensus` contract to `engine/authorityRound/params/validators/multi`;
  add `blockRewardContractAddress` (obtained from step 1) and `blockRewardContractTransition` (equal to `4639000`) to `engine/authorityRound/params`.
3. Organize the HF on block `4622420`.

### Increased Emission Supply

In the scope of this hard fork, the emission supply will be increased by 1 POA per block.

POA has a block time of __~5__ seconds and rewards each validated block miner __1 POA__ for each block. These block rewards never run out and after the hard fork there will be __2 POA__ minted per block. The remaining __1 POA__ per block will be put aside to benefit the network however the current Validators vote to choose, some example use cases are to Burn coins, hold coins or spend on R&D for the POA Foundation. Validator's reward will remain at __1 POA__ after this transition.

You can find more info located in the [POA Whitepaper Economy Section](https://github.com/poanetwork/wiki/wiki/POA-Network-Whitepaper#economy) and [RFC issue #14](https://github.com/poanetwork/RFC/issues/14).

## Instructions

You should follow this instruction to replace `spec.json` on your node:
https://github.com/poanetwork/poa-devops/blob/master/docs/Spec-hardfork.md

* on STEP 2 (create group_vars/all...) use the following parameters:
```
MAIN_REPO_FETCH: "poanetwork"
GENESIS_BRANCH: "sokol"
```

* on STEP 3 (create/edit hosts file...) please double-check that you're using your `SOKOL` node's IP address

* on STEP 6 (connect to the node...) after you've done all the checks, also verify HF block number:
```
grep -n -A2 4622420 spec.json
```
You should see:
```
>             "4622420": {
>                 "safeContract": "0x03048F666359CFD3C74a1A5b9a97848BF71d5038"
>             }

```
